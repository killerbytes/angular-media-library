"use strict";var app=angular.module("mediaLibraryWebApp",["ngAnimate","ngCookies","ngResource","ngRoute","ngSanitize","ngTouch","duScroll","ui.bootstrap"]).constant("config",{imgBase:"/",apiBase:"http://localhost:3000",imdbBase:"//www.omdbapi.com"}).config(["$routeProvider",function(a){a.when("/videos",{templateUrl:"views/videos/index.html",controller:"VideosCtrl",resolve:{videos:["mdVideo",function(a){return a.list(1,99999,!0)}],genres:["mdGenre",function(a){return a.list()}]}}).when("/videos/:id/edit",{templateUrl:"views/videos/edit.html",controller:"AdminVideoCtrl",resolve:{videos:["mdVideo",function(){return[]}],genres:["mdGenre",function(a){return a.list()}]}}).when("/videos/:id/:imdb",{templateUrl:"views/videos/show.html",controller:"VideosCtrl",resolve:{videos:["mdVideo",function(){return[]}],genres:["mdGenre",function(a){return a.list()}]}}).when("/search/:type/:query",{templateUrl:"views/search.html",controller:"SearchCtrl",resolve:{videos:["mdVideo",function(a){return a.list(1,999999,!0)}]}}).when("/admin/videos/",{templateUrl:"views/admin/videos/index.html",controller:"AdminVideoCtrl",resolve:{videos:["mdVideo",function(a){return a.list(1,999999,!0)}]}}).when("/admin/videos/raw",{templateUrl:"views/admin/videos/raw.html",controller:"AdminVideoCtrl",resolve:{videos:["mdVideo",function(a){return a.list(1,1e5,!1)}]}}).otherwise({redirectTo:"/videos"})}]).run(["$rootScope","config",function(a,b){a.config=b}]),xx;app.controller("AdminVideoCtrl",["$scope","$modal","$routeParams","$document","mdVideo","mdImdb","videos",function(a,b,c,d,e,f,g){function h(b){a.isLoading=!0,e.list(b).then(function(c){a.videos=a.videos.concat(c),a.list.data("page",b),a.isLoading=!1})}function i(a){return{title:a.Title,year:a.Year,imdb:a.imdbID,genre:a.Genre,actors:a.Actors,rating:a.imdbRating,poster:a.Poster}}function j(a){a.attachments="N/A"==a.poster||"posters/placeholder.jpg"==a.poster?null:a.poster,delete a.results,e.update(a).then(function(){console.log("updated")})}a.videos=g,a.page=1,c.id&&e.get(c.id).then(function(b){a.video=b}),a.$watch("page",function(b,c){if(b!=c){if(a.isLoading)return!1;h(a.page)}}),a.load=function(){a.list=angular.element(".video-list"),a.page=a.list.data("page")+1},a.getImdb=function(b,c){f.get(b).then(function(b){a.item=b,c.data=b})},a.downloadPosters=function(){_.forEach(a.videos,function(a){a.attachments_file_name||(a.attachments=a.poster,j(a))})},a.selectImdb=function(a,b){a.data?(angular.extend(b,i(a.data)),b.attachments=b.poster,b.status=!0,j(b)):f.get(a.imdbID).then(function(a){angular.extend(b,i(a)),b.status=!0,j(b)})},a["delete"]=function(a){a.deleted=!0,j(a)},a.saveVideo=function(a){j(a)},a.lookup=function(a,c){var d=b.open({templateUrl:"views/template/lookup.html",controller:"ModalInstanceCtrl",size:c||"sm",resolve:{items:function(){return{item:a}}}});d.result.then(function(b){console.log(b),a.results=b},function(){})},d.on("scroll",function(){d.scrollTop()>angular.element(".video-list").height()-500&&(a.scrolling=!0,a.$apply(a.load()))})}]),app.controller("VideosCtrl",["$scope","$modal","$routeParams","$document","$sce","mdVideo","mdImdb","mdUtils","videos","genres",function(a,b,c,d,e,f,g,h,i,j){a.Utils=h,a.$sce=e,a.videos=i,a.genres=j,a.id=c.id,a.isNew=function(a){return moment().diff(a,"days")<30},a.TOC=[],_.forEach(i,function(b){-1===a.TOC.indexOf(b.title.charAt(0).toUpperCase())&&a.TOC.push(b.title.charAt(0))}),c.id&&(f.get(c.id).then(function(b){a.video=b}),g.get(c.imdb).then(function(b){a.imdb=b})),a.scrollTo=function(a){var b=angular.element("[data-title^="+a+"]");d.scrollToElement(b,60,500)}}]);var xx;app.controller("SearchCtrl",["$scope","$modal","$routeParams","mdVideo","videos",function(a,b,c,d,e){a.videos=e,a.search={},a.search[c.type]=c.query,a.getType=function(){return Object.keys(a.search)}}]),app.controller("ModalInstanceCtrl",["$scope","$modalInstance","mdImdb","mdUtils","items",function(a,b,c,d,e){a.search={query:d.parseFilename(e.item.filename)},a.lookup=function(a){a.imdb?c.get(a.query).then(function(a){b.close([{Title:a.Title,Year:a.Year,imdbID:a.imdbID,Type:"movie"}])}):c.search(a.query).then(function(a){b.close(a.Search)})}}]),app.directive("getVideo",["config","mdImdb","mdUtils",function(a,b,c){return{restrict:"A",link:function(a){var d=c.parseFilename(a.video.filename);b.search(d).then(function(d){if("False"==d.Response){var e=c.parseFilename(a.video.folder);b.search(e).then(function(b){a.video.results=b.Search})}a.video.results=d.Search})}}}]),app.directive("showPoster",["config","mdImdb","mdUtils","$timeout",function(a,b){return{restrict:"A",link:function(a,c){function d(){b.get(a.item.imdbID).then(function(){})}c.on("click",function(a){a.preventDefault(),d()})}}}]),app.directive("mySrc",function(){return{link:function(a,b,c){var d,e;d=null,e=function(){var a=b.parent();a.addClass("loading"),d=new Image,d.src=c.mySrc,d.onload=function(){b[0].src=c.mySrc,a.removeClass("loading")}},a.$watch(function(){return c.mySrc},function(){e()})}}}),app.factory("mdUtils",["$q","$http","config",function(){var a=function(a){angular.extend(this,a)};return a.parseFilename=function(a){var b=[/\.mkv/g,/\.avi/g,/\.mp4/g,/\./g],c=[/\//g],d=a;_.forEach(b,function(a){d=d.replace(a," ")}),_.forEach(c,function(a){d=d.replace(a,"")});for(var e=1990;2015>=e;e++){var f=new RegExp(e,"g");d=d.replace(f,"")}return d.split(" ").slice(0,2).join(" ")},a.humanFileSizezx=function(a,b){var c=b?1e3:1024;if(c>a)return a+" B";var d=b?["kB","MB","GB","TB","PB","EB","ZB","YB"]:["KiB","MiB","GiB","TiB","PiB","EiB","ZiB","YiB"],e=-1;do a/=c,++e;while(a>=c);return a.toFixed(1)+" "+d[e]},a.humanFileSize=function(a){var b=Math.floor(Math.log(a)/Math.log(1024));return 1*(a/Math.pow(1024,b)).toFixed(2)+" "+["B","kB","MB","GB","TB"][b]},a.getBase64FromImageUrl=function(a){var b=new Image;b.src=a,b.onload=function(){console.log(this);var a=document.getElementById("canvas");a.width=this.width,a.height=this.height;var b=a.getContext("2d");b.drawImage(this,0,0);var c=a.toDataURL("image/png");return c.replace(/^data:image\/(png|jpg);base64,/,"")}},a}]),app.factory("mdGenre",["$q","$http","config",function(a,b){var c=(angular.injector(["ng"]),function(a){angular.extend(this,a)});return c.list=function(){var c=a.defer();return b.get("/data/genres.json").success(function(a){c.resolve(a)}),c.promise},c}]),app.factory("mdVideo",["$q","$http","config",function(a,b,c){var d=(angular.injector(["ng"]),null),e=function(a){angular.extend(this,a)};return e.list=function(e,f,g){var h=a.defer(),e=e||1,f=f||10,g=g||!1;return d?h.resolve(d):b.get(c.apiBase+"/videos.json",{cache:!1,params:{page:e,per_page:f,status:g}}).success(function(a){d=a,h.resolve(a)}),h.promise},e.get=function(f){var g=a.defer();return"/data"==c.apiBase?d?g.resolve(_.find(d,{id:parseInt(f)})):e.list(1,99999,!0).then(function(a){d=a,g.resolve(_.find(a,{id:parseInt(f)}))}):b.get(c.apiBase+"/videos/"+f+".json",{},{headers:{Accept:void 0}}).success(function(a){g.resolve(a)}),g.promise},e.update=function(d){var e=a.defer();return b.put(c.apiBase+"/videos/"+d.id+".json",{video:d}).success(function(a){e.resolve(a)}),e.promise},e}]),app.factory("mdImdb",["$q","$http","config",function(a,b,c){var d=(angular.injector(["ng"]),function(a){angular.extend(this,a)});return d.list=function(d){var e=a.defer(),d=d||1;return b.get(c.apiBase+"/videos.json?page="+d).success(function(a){e.resolve(a)}),e.promise},d.get=function(d){var e=a.defer();return b.get(c.imdbBase+"?i="+d).success(function(a){e.resolve(a)}),e.promise},d.search=function(d){var e=a.defer();return b.get(c.imdbBase+"?s="+d).success(function(a){e.resolve(a)}),e.promise},d}]);